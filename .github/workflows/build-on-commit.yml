name: Build site (images + HTML)

permissions:
  contents: write

on:
  push:
    paths:
      - 'images/**'
      - 'data/*.json'
      - 'data/**/*.json'
      - 'templates/*.hbs'
      - 'templates/**/*.hbs'
  pull_request:
    paths:
      - 'images/**'
      - 'data/*.json'
      - 'data/**/*.json'
      - 'templates/*.hbs'
      - 'templates/**/*.hbs'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # --- CHECKOUT ---

      - name: Checkout full history (needed for git diff)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --- DIFF RANGE ---

      - name: Work out diff range
        id: diff
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "base=${{ github.event.pull_request.base.sha }}" >> "$GITHUB_OUTPUT"
            echo "head=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
          else
            BEFORE="${{ github.event.before }}"
            # Handle new branches where BEFORE can be all zeros
            if [[ -z "$BEFORE" || "$BEFORE" == "0000000000000000000000000000000000000000" ]]; then
              BEFORE=$(git rev-list --max-parents=0 HEAD)
            fi
            echo "base=$BEFORE" >> "$GITHUB_OUTPUT"
            echo "head=${{ github.sha }}" >> "$GITHUB_OUTPUT"
          fi

      # --- FIND DELETED / RENAMED IMAGES (to delete their webp) ---

      - name: List deleted/renamed images under /images
        id: removed_images
        shell: bash
        run: |
          set -eo pipefail
          # Use name-status so we can see D and R with old paths
          CHANGED=$(
            git diff --name-status -M \
              "${{ steps.diff.outputs.base }}" "${{ steps.diff.outputs.head }}" -- \
              'images/**/*.*' \
            | grep -Ei '\.(jpe?g|png|gif|tiff?|bmp|webp|avif|svg)$' || true
          )

          # Extract old paths for:
          # - D (deleted):  D   images/foo.jpg
          # - R (renamed): R100 images/old.jpg  images/new.jpg
          REMOVED=$(
            printf '%s\n' "$CHANGED" | awk '
              $1 == "D" { print $2 }
              $1 ~ /^R[0-9]+$/ { print $2 }
            ' || true
          )

          {
            echo "list<<EOF"
            echo "$REMOVED"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Delete corresponding .webp files in /www/images
        if: ${{ steps.removed_images.outputs.list != '' }}
        shell: bash
        run: |
          set -euo pipefail
          while IFS= read -r src; do
            [[ -z "$src" ]] && continue
            rel="${src#images/}"
            dest="www/images/${rel%.*}.webp"
            echo "Deleting derivative for removed image: $dest"
            rm -f "$dest" || true
          done <<< "${{ steps.removed_images.outputs.list }}"

      # --- FIND ADDED / MODIFIED IMAGES (to regenerate webp) ---

      - name: List added/modified images under /images
        id: files
        shell: bash
        run: |
          set -eo pipefail
          # A = Added, M = Modified, R = Renamed, C = Copied
          CHANGED=$(git diff --name-only --diff-filter=AMRC \
            "${{ steps.diff.outputs.base }}" "${{ steps.diff.outputs.head }}" -- \
            'images/**/*.*' | grep -Ei '\.(jpe?g|png|gif|tiff?|bmp|webp|avif|svg)$' || true)

          {
            echo "list<<EOF"
            echo "$CHANGED"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      # --- IMAGE CONVERSION ---

      - name: Install ImageMagick
        shell: bash
        run: |
          if ! command -v magick >/dev/null 2>&1 && ! command -v convert >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y imagemagick
          fi
          (magick -version || convert -version) || true

      - name: Convert to 400px-wide .webp in /www/images (overwrite if exists)
        if: ${{ steps.files.outputs.list != '' }}
        shell: bash
        run: |
          set -euo pipefail

          convert_one () {
            src="$1"
            rel="${src#images/}"
            dest="www/images/${rel%.*}.webp"
            mkdir -p "$(dirname "$dest")"

            if command -v magick >/dev/null 2>&1; then
              magick "$src[0]" -strip -resize 400x -quality 80 "$dest"
            else
              convert "$src[0]" -strip -resize 400x -quality 80 "$dest"
            fi

            echo "Wrote: $dest"
          }

          while IFS= read -r f; do
            [[ -z "$f" ]] && continue
            convert_one "$f"
          done <<< "${{ steps.files.outputs.list }}"

      - name: Debug git state
        run: |
          pwd
          ls -la www/images || true
          echo
          echo "Untracked under www/images:"
          git ls-files -o -- www/images || true
          echo
          echo "Git status:"
          git status --porcelain

      # --- HTML BUILD ---

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Generate HTML
        run: npm run build

      - name: Upload HTML preview (PRs)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: generated-html
          path: 'www'

      # --- AUTO-COMMIT GENERATED OUTPUT (push only) ---

      - name: Commit generated output (push)
        if: ${{ github.event_name == 'push' }}
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: rebuild HTML & 400px webp images [skip ci]"
          file_pattern: |
            www
